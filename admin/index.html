<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>팝업 관리 - 공방 사람들</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans KR', 'Apple SD Gothic Neo', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            display: flex;
            min-height: 100vh;
        }
        
        /* 사이드바 스타일 */
        .sidebar {
            width: 250px;
            background-color: #2c2c2c;
            color: white;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 30px 20px;
            background-color: #1a1a1a;
            border-bottom: 1px solid #444;
        }
        
        .sidebar-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .sidebar-subtitle {
            font-size: 12px;
            color: #999;
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .menu-section {
            margin-bottom: 30px;
        }
        
        .menu-label {
            padding: 0 20px;
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .menu-item {
            display: block;
            padding: 12px 20px;
            color: #ccc;
            text-decoration: none;
            transition: all 0.3s;
            position: relative;
        }
        
        .menu-item:hover {
            background-color: #3a3a3a;
            color: white;
        }
        
        .menu-item.active {
            background-color: #6b5344;
            color: white;
        }
        
        .menu-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background-color: #fff;
        }
        
        /* 메인 컨텐츠 영역 */
        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 40px;
        }
        
        .content-header {
            background: white;
            padding: 25px 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            color: #6b5344;
            font-size: 28px;
        }
        
        /* 팝업 목록 테이블 */
        .list-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-add {
            padding: 10px 20px;
            background: #6b5344;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-add:hover {
            background: #5a4337;
        }
        
        .popup-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .popup-table th {
            background: #f8f8f8;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #ddd;
            color: #555;
            font-weight: 500;
        }
        
        .popup-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .popup-table tr:hover {
            background: #fafafa;
        }
        
        .popup-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-scheduled {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-ended {
            background: #f8d7da;
            color: #721c24;
        }
        
        .popup-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            background: #f5f5f5;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn-edit, .btn-delete, .btn-view {
            padding: 6px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            min-width: 35px;
        }
        
        .btn-edit {
            background: #9b8579;
            color: white;
        }
        
        .btn-view {
            background: #6c757d;
            color: white;
        }
        
        .btn-delete {
            background: #d9534f;
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        /* 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }
        
        /* 체크박스가 있는 폼 그룹 스타일 */
        .form-group {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .form-group.disabled {
            opacity: 0.5;
        }
        
        .form-group.disabled textarea,
        .form-group.disabled .image-upload {
            pointer-events: none;
        }
        
        .form-group.disabled input[type="text"] {
            pointer-events: none;
        }
        
        .form-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .form-header input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .form-header label {
            margin: 0;
            cursor: pointer;
            font-weight: 600;
            color: #6b5344;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        input[type="text"],
        input[type="date"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .date-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }
        
        .btn-save, .btn-cancel {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-save {
            background: #6b5344;
            color: white;
        }
        
        .btn-cancel {
            background: #ccc;
            color: #333;
        }
        
        /* 이미지 업로드 */
        .image-upload {
            border: 2px dashed #ddd;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .image-upload:hover {
            border-color: #6b5344;
            background-color: #fafafa;
        }
        
        .image-upload.disabled {
            cursor: not-allowed;
            border-color: #e0e0e0;
        }
        
        .image-preview {
            margin-top: 15px;
            max-width: 300px;
            display: none;
        }
        
        .image-preview img {
            width: 100%;
            height: auto;
            border-radius: 4px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        /* 모바일 반응형 */
        .mobile-menu-btn {
            display: none;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
                z-index: 1000;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 20px;
            }
            
            .mobile-menu-btn {
                display: block;
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 999;
                background: #6b5344;
                color: white;
                border: none;
                padding: 10px;
                border-radius: 4px;
                cursor: pointer;
            }
            
            .content-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .popup-table {
                font-size: 12px;
            }
            
            .popup-table th,
            .popup-table td {
                padding: 8px 5px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .popup-thumbnail {
                width: 40px;
                height: 40px;
            }
            
            .hide-mobile {
                display: none;
            }
            
            @media (max-width: 480px) {
                .popup-table th:nth-child(1),
                .popup-table td:nth-child(1) {
                    display: none;
                }
            }
        }
    </style>
</head>
<body>
    <!-- 모바일 메뉴 버튼 -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">☰ 메뉴</button>
    
    <!-- 사이드바 -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">공방 사람들</div>
            <div class="sidebar-subtitle">관리자 페이지</div>
        </div>
        
        <nav class="sidebar-menu">
            <div class="menu-section">
                <div class="menu-label">메인</div>
                <a href="../index.html" class="menu-item">홈페이지 바로가기</a>
            </div>
            
            <div class="menu-section">
                <div class="menu-label">팝업 관리</div>
                <a href="index.html" class="menu-item active">팝업 목록 관리</a>
            </div>
        </nav>
    </div>
    
    <!-- 메인 컨텐츠 -->
    <div class="main-content">
        <div class="content-header">
            <h1>팝업 목록 관리</h1>
            <button class="btn-add" onclick="showAddModal()">새 팝업 추가</button>
        </div>
        
        <div class="list-section">
            <div id="popupListContainer">
                <!-- 팝업 목록이 여기에 동적으로 생성됩니다 -->
            </div>
        </div>
    </div>
    
    <!-- 팝업 추가/수정 모달 -->
    <div id="popupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">새 팝업 추가</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            
            <!-- 제목 입력 그룹 -->
            <div class="form-group" id="title-group">
                <div class="form-header">
                    <input type="checkbox" id="use-title" checked onchange="toggleField('title')">
                    <label for="use-title">제목 사용</label>
                </div>
                <input type="text" id="popup-title" placeholder="팝업 제목을 입력하세요">
            </div>
            
            <!-- 내용 입력 그룹 -->
            <div class="form-group" id="content-group">
                <div class="form-header">
                    <input type="checkbox" id="use-content" checked onchange="toggleField('content')">
                    <label for="use-content">내용 사용</label>
                </div>
                <textarea id="popup-content" placeholder="팝업 내용을 입력하세요"></textarea>
            </div>
            
            <!-- 날짜 입력 그룹 -->
            <div class="form-group">
                <label>공지 기간</label>
                <div class="date-group">
                    <div>
                        <label style="font-weight: normal; font-size: 14px;">시작 날짜</label>
                        <input type="date" id="start-date">
                    </div>
                    <div>
                        <label style="font-weight: normal; font-size: 14px;">종료 날짜</label>
                        <input type="date" id="end-date">
                    </div>
                </div>
            </div>
            
            <!-- 이미지 입력 그룹 -->
            <div class="form-group" id="image-group">
                <div class="form-header">
                    <input type="checkbox" id="use-image" onchange="toggleField('image')">
                    <label for="use-image">이미지 사용</label>
                </div>
                <div class="image-upload disabled" id="image-upload-area" onclick="if(!this.classList.contains('disabled')) document.getElementById('popup-image').click()">
                    <p id="upload-text">클릭하여 이미지를 선택하세요</p>
                    <input type="file" id="popup-image" accept="image/*" onchange="previewImage(event)">
                </div>
                <div class="image-preview" id="image-preview">
                    <img id="preview-img" src="" alt="미리보기">
                    <button type="button" onclick="removeImage()" style="margin-top: 10px; padding: 5px 15px; font-size: 14px;">이미지 제거</button>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal()">취소</button>
                <button class="btn-save" onclick="savePopup()">저장</button>
            </div>
        </div>
    </div>
    
    <script>
        let popups = [];
        let editingIndex = null;
        
        // 서버 API URL
        const API_BASE = '';  // 같은 도메인에서 실행되므로 빈 문자열
        
        // 페이지 로드 시 팝업 목록 불러오기
        window.onload = function() {
            loadPopups();
        };
        
        // 사이드바 토글
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }
        
        // 필드 토글 함수
        function toggleField(field) {
            if (field === 'title') {
                const checkbox = document.getElementById('use-title');
                const input = document.getElementById('popup-title');
                const group = document.getElementById('title-group');
                
                if (!checkbox.checked) {
                    input.value = '';
                    group.classList.add('disabled');
                } else {
                    group.classList.remove('disabled');
                }
            } else if (field === 'content') {
                const checkbox = document.getElementById('use-content');
                const textarea = document.getElementById('popup-content');
                const group = document.getElementById('content-group');
                
                if (!checkbox.checked) {
                    textarea.value = '';
                    group.classList.add('disabled');
                } else {
                    group.classList.remove('disabled');
                }
            } else if (field === 'image') {
                const checkbox = document.getElementById('use-image');
                const uploadArea = document.getElementById('image-upload-area');
                const group = document.getElementById('image-group');
                
                if (!checkbox.checked) {
                    removeImage();
                    uploadArea.classList.add('disabled');
                    group.classList.add('disabled');
                } else {
                    uploadArea.classList.remove('disabled');
                    group.classList.remove('disabled');
                }
            }
        }
        
        // 팝업 목록 불러오기 (서버에서)
        async function loadPopups() {
            try {
                const response = await fetch(`${API_BASE}/api/popups`);
                if (!response.ok) {
                    throw new Error('서버에서 데이터를 가져올 수 없습니다.');
                }
                popups = await response.json();
                renderPopupList();
            } catch (error) {
                console.error('팝업 목록 불러오기 오류:', error);
                
                // 서버 연결 실패시 localStorage 백업 사용
                const savedPopups = localStorage.getItem('popupsList');
                if (savedPopups) {
                    popups = JSON.parse(savedPopups);
                    renderPopupList();
                    alert('서버 연결에 실패했습니다. 로컬 데이터를 사용합니다.');
                } else {
                    alert('서버에 연결할 수 없습니다. 서버가 실행 중인지 확인해주세요.');
                }
            }
        }
        
        // 팝업 목록 렌더링
        function renderPopupList() {
            const container = document.getElementById('popupListContainer');
            
            if (popups.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>등록된 팝업이 없습니다</h3>
                        <p>새 팝업을 추가하여 시작하세요</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table class="popup-table">
                    <thead>
                        <tr>
                            <th style="width: 80px;">이미지</th>
                            <th>제목</th>
                            <th class="hide-mobile" style="width: 100px;">시작일</th>
                            <th class="hide-mobile" style="width: 100px;">종료일</th>
                            <th style="width: 80px;">상태</th>
                            <th style="width: 180px;">관리</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            popups.forEach((popup, index) => {
                const status = getPopupStatus(popup);
                const statusClass = status === '진행중' ? 'status-active' : 
                                  status === '예정' ? 'status-scheduled' : 'status-ended';
                
                html += `
                    <tr>
                        <td>
                            ${popup.image ? 
                                `<img src="${popup.image}" class="popup-thumbnail">` : 
                                '<div class="popup-thumbnail" style="background:#f5f5f5;"></div>'
                            }
                        </td>
                        <td>${popup.title || '제목 없음'}</td>
                        <td class="hide-mobile">${popup.startDate || '-'}</td>
                        <td class="hide-mobile">${popup.endDate || '-'}</td>
                        <td><span class="popup-status ${statusClass}">${status}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-view" onclick="viewPopup(${index})">보기</button>
                                <button class="btn-edit" onclick="editPopup(${index})">수정</button>
                                <button class="btn-delete" onclick="deletePopup(${index})">삭제</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // 팝업 상태 확인
        function getPopupStatus(popup) {
            const today = new Date().toISOString().split('T')[0];
            
            if (!popup.startDate && !popup.endDate) return '상시';
            if (popup.startDate && today < popup.startDate) return '예정';
            if (popup.endDate && today > popup.endDate) return '종료';
            return '진행중';
        }
        
        // 새 팝업 추가 모달 표시
        function showAddModal() {
            editingIndex = null;
            document.getElementById('modalTitle').textContent = '새 팝업 추가';
            
            // 체크박스 초기화
            document.getElementById('use-title').checked = true;
            document.getElementById('use-content').checked = true;
            document.getElementById('use-image').checked = false;
            
            // 입력 필드 초기화
            document.getElementById('popup-title').value = '';
            document.getElementById('popup-content').value = '';
            
            // 그룹 상태 초기화
            document.getElementById('title-group').classList.remove('disabled');
            document.getElementById('content-group').classList.remove('disabled');
            document.getElementById('image-group').classList.add('disabled');
            document.getElementById('image-upload-area').classList.add('disabled');
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start-date').value = today;
            
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('end-date').value = nextWeek.toISOString().split('T')[0];
            
            removeImage();
            document.getElementById('popupModal').style.display = 'block';
        }
        
        // 팝업 수정
        function editPopup(index) {
            editingIndex = index;
            const popup = popups[index];
            
            document.getElementById('modalTitle').textContent = '팝업 수정';
            
            // 체크박스 설정
            document.getElementById('use-title').checked = popup.useTitle !== false;
            document.getElementById('use-content').checked = popup.useContent !== false;
            document.getElementById('use-image').checked = popup.useImage === true;
            
            // 값 설정
            document.getElementById('popup-title').value = popup.title || '';
            document.getElementById('popup-content').value = popup.content || '';
            document.getElementById('start-date').value = popup.startDate || '';
            document.getElementById('end-date').value = popup.endDate || '';
            
            // 그룹 상태 설정
            toggleField('title');
            toggleField('content');
            toggleField('image');
            
            if (popup.image) {
                document.getElementById('preview-img').src = popup.image;
                document.getElementById('image-preview').style.display = 'block';
                document.getElementById('upload-text').textContent = '이미지가 선택되었습니다';
            }
            
            document.getElementById('popupModal').style.display = 'block';
        }
        
        // 팝업 보기
        function viewPopup(index) {
            const popup = popups[index];
            let message = '';
            
            if (popup.title) message += `제목: ${popup.title}\n`;
            if (popup.content) message += `내용: ${popup.content}\n`;
            message += `기간: ${popup.startDate || '시작일 없음'} ~ ${popup.endDate || '종료일 없음'}\n`;
            if (popup.image) message += '이미지: 있음';
            
            alert(message);
        }
        
        // 팝업 삭제 (서버에서)
        async function deletePopup(index) {
            if (!confirm('이 팝업을 삭제하시겠습니까?')) {
                return;
            }
            
            const popup = popups[index];
            
            try {
                const response = await fetch(`${API_BASE}/api/popups/${popup.id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('서버에서 삭제하지 못했습니다.');
                }
                
                // 성공시 로컬 배열에서도 제거
                popups.splice(index, 1);
                renderPopupList();
                
            } catch (error) {
                console.error('팝업 삭제 오류:', error);
                alert('팝업 삭제에 실패했습니다.');
            }
        }
        
        // 이미지 미리보기 및 압축
        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                // 파일 크기 체크 (10MB 이하)
                if (file.size > 10 * 1024 * 1024) {
                    alert('이미지 크기는 10MB 이하로 해주세요.');
                    event.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        const maxWidth = 800;
                        const maxHeight = 600;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth || height > maxHeight) {
                            const ratio = Math.min(maxWidth / width, maxHeight / height);
                            width *= ratio;
                            height *= ratio;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        
                        document.getElementById('preview-img').src = compressedDataUrl;
                        document.getElementById('image-preview').style.display = 'block';
                        document.getElementById('upload-text').textContent = '이미지가 선택되었습니다';
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // 이미지 제거
        function removeImage() {
            document.getElementById('popup-image').value = '';
            document.getElementById('preview-img').src = '';
            document.getElementById('image-preview').style.display = 'none';
            document.getElementById('upload-text').textContent = '클릭하여 이미지를 선택하세요';
        }
        
        // 팝업 저장 (서버에)
        async function savePopup() {
            const useTitle = document.getElementById('use-title').checked;
            const useContent = document.getElementById('use-content').checked;
            const useImage = document.getElementById('use-image').checked;
            
            // 최소 하나는 선택해야 함
            if (!useTitle && !useContent && !useImage) {
                alert('최소 하나의 항목은 선택해야 합니다.');
                return;
            }
            
            const title = useTitle ? document.getElementById('popup-title').value : '';
            const content = useContent ? document.getElementById('popup-content').value : '';
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            // 선택된 항목이 비어있는지 체크
            if (useTitle && !title) {
                alert('제목을 입력해주세요.');
                return;
            }
            
            if (useContent && !content) {
                alert('내용을 입력해주세요.');
                return;
            }
            
            if (useImage && !document.getElementById('preview-img').src) {
                alert('이미지를 선택해주세요.');
                return;
            }
            
            const popupData = {
                id: editingIndex !== null ? popups[editingIndex].id : null, // 새 팝업은 null
                useTitle: useTitle,
                useContent: useContent,
                useImage: useImage,
                title: title,
                content: content,
                startDate: startDate,
                endDate: endDate,
                image: useImage ? document.getElementById('preview-img').src : null,
                savedAt: new Date().toISOString()
            };
            
            try {
                const response = await fetch(`${API_BASE}/api/popups`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(popupData)
                });
                
                if (!response.ok) {
                    throw new Error('서버에 저장하지 못했습니다.');
                }
                
                const result = await response.json();
                
                // 로컬 배열 업데이트
                if (editingIndex !== null) {
                    popups[editingIndex] = result.popup;
                } else {
                    popups.push(result.popup);
                }
                
                closeModal();
                renderPopupList();
                
            } catch (error) {
                console.error('팝업 저장 오류:', error);
                alert('팝업 저장에 실패했습니다.');
            }
        }
        
        // 모달 닫기
        function closeModal() {
            document.getElementById('popupModal').style.display = 'none';
        }
    </script>
</body>
</html>